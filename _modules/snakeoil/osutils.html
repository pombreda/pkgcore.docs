
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>snakeoil.osutils &mdash; snakeoil v-trunk documentation</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '-trunk',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="snakeoil v-trunk documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">snakeoil v-trunk documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for snakeoil.osutils</h1><div class="highlight"><pre>
<span class="c"># Copyright 2004-2010 Brian Harring &lt;ferringb@gmail.com&gt;</span>
<span class="c"># Copyright 2006 Marien Zwart &lt;marienz@gentoo.org&gt;</span>
<span class="c"># License: BSD/GPL2</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">OS related functionality</span>

<span class="sd">This module is primarily optimized implementations of various filesystem operations,</span>
<span class="sd">written for posix specifically.  If this is a non-posix system (or extensions were</span>
<span class="sd">disabled) it falls back to native python implementations that yield no real speed gains.</span>

<span class="sd">A rough example of the performance benefits, collected from a core2 2.4GHz running</span>
<span class="sd">python 2.6.5, w/ an EXT4 FS on a 160GB x25-M for the FS related invocations (it&#39;s worth</span>
<span class="sd">noting the IO is pretty fast in this setup- for slow IO like nfs, the speedup for extension</span>
<span class="sd">vs native for listdir* functionality is a fair bit larger).</span>

<span class="sd">Rough stats:</span>

<span class="sd">========================================================  =========   ===============</span>
<span class="sd">python -m timeit code snippet                             native      extension time</span>
<span class="sd">========================================================  =========   ===============</span>
<span class="sd">join(&quot;/usr/portage&quot;, &quot;dev-util&quot;, &quot;bsdiff&quot;, &quot;ChangeLog&quot;)   2.8 usec    0.36 usec</span>
<span class="sd">normpath(&quot;/usr/portage/foon/blah/dar&quot;)                    5.52 usec   0.15 usec</span>
<span class="sd">normpath(&quot;/usr/portage//foon/blah//dar&quot;)                  5.66 usec   0.15 usec</span>
<span class="sd">normpath(&quot;/usr/portage/./foon/../blah/&quot;)                  5.92 usec   0.15 usec</span>
<span class="sd">listdir_files(&quot;/usr/lib64&quot;) # 2338 entries, 990 syms      18.6 msec   4.17 msec</span>
<span class="sd">listdir_files(&quot;/usr/lib64&quot;, False) # same dir content     16.9 msec   1.48 msec</span>
<span class="sd">readfile(&quot;/etc/passwd&quot;) # 1899 bytes                      20.4 usec   4.05 usec</span>
<span class="sd">readfile(&quot;tmp-file&quot;) # 1MB                                300 usec    259 usec</span>
<span class="sd">list(readlines(&quot;/etc/passwd&quot;)) # 1899 bytes, 34 lines     37.3 usec   12.8 usec</span>
<span class="sd">list(readlines(&quot;/etc/passwd&quot;, False)) # leave whitespace  26.7 usec   12.8 usec</span>
<span class="sd">========================================================  =========   ===============</span>

<span class="sd">If you&#39;re just invoking join or normpath, or reading a file or two a couple of times,</span>
<span class="sd">these optimizations are probably overkill.  If you&#39;re doing lots of path manipulation,</span>
<span class="sd">reading files, scanning directories, etc, these optimizations start adding up</span>
<span class="sd">pretty quickly.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;abspath&#39;</span><span class="p">,</span> <span class="s">&#39;abssymlink&#39;</span><span class="p">,</span> <span class="s">&#39;ensure_dirs&#39;</span><span class="p">,</span> <span class="s">&#39;join&#39;</span><span class="p">,</span> <span class="s">&#39;pjoin&#39;</span><span class="p">,</span>
    <span class="s">&#39;listdir_files&#39;</span><span class="p">,</span> <span class="s">&#39;listdir_dirs&#39;</span><span class="p">,</span> <span class="s">&#39;listdir&#39;</span><span class="p">,</span>
    <span class="s">&#39;readdir&#39;</span><span class="p">,</span> <span class="s">&#39;normpath&#39;</span><span class="p">,</span> <span class="s">&#39;unlink_if_exists&#39;</span><span class="p">,</span>
    <span class="s">&#39;FsLock&#39;</span><span class="p">,</span> <span class="s">&#39;GenericFailed&#39;</span><span class="p">,</span>
    <span class="s">&#39;LockException&#39;</span><span class="p">,</span> <span class="s">&#39;NonExistant&#39;</span><span class="p">]</span>
<span class="n">__all__</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;readfile&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span>
        <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;_ascii&#39;</span><span class="p">,</span> <span class="s">&#39;_ascii_strict&#39;</span><span class="p">,</span> <span class="s">&#39;_bytes&#39;</span><span class="p">,</span> <span class="s">&#39;_utf8&#39;</span><span class="p">])</span>
<span class="n">__all__</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;readlines&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span>
        <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;_ascii&#39;</span><span class="p">,</span> <span class="s">&#39;_ascii_strict&#39;</span><span class="p">,</span> <span class="s">&#39;_bytes&#39;</span><span class="p">,</span> <span class="s">&#39;_utf8&#39;</span><span class="p">,</span> <span class="s">&#39;_utf8_strict&#39;</span><span class="p">])</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">__all__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">fcntl</span>
<span class="kn">import</span> <span class="nn">errno</span>

<span class="c"># No name &#39;_readdir&#39; in module osutils</span>
<span class="c"># pylint: disable-msg=E0611</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">snakeoil.osutils</span> <span class="kn">import</span> <span class="n">_readdir</span> <span class="k">as</span> <span class="n">module</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">snakeoil.osutils</span> <span class="kn">import</span> <span class="n">native_readdir</span> <span class="k">as</span> <span class="n">module</span>

<span class="c"># delay this... it&#39;s a 1ms hit, and not a lot of the consumers</span>
<span class="c"># force utf8 codepaths yet.</span>
<span class="kn">from</span> <span class="nn">snakeoil</span> <span class="kn">import</span> <span class="n">compatibility</span>
<span class="kn">from</span> <span class="nn">snakeoil.weakrefs</span> <span class="kn">import</span> <span class="n">WeakRefFinalizer</span>
<span class="kn">from</span> <span class="nn">snakeoil.demandload</span> <span class="kn">import</span> <span class="n">demandload</span>
<span class="n">demandload</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span> <span class="s">&quot;codecs&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">snakeoil.currying</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">pretty_docs</span>

<span class="n">listdir</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">listdir</span>
<span class="n">listdir_dirs</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">listdir_dirs</span>
<span class="n">listdir_files</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">listdir_files</span>
<span class="n">readdir</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">readdir</span>

<span class="k">del</span> <span class="n">module</span>

<span class="k">def</span> <span class="nf">_safe_mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="c"># if it exists already and is a dir, non issue.</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="ensure_dirs"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.ensure_dirs">[docs]</a><span class="k">def</span> <span class="nf">ensure_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">gid</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">uid</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mo">0777</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ensure dirs exist, creating as needed with (optional) gid, uid, and mode.</span>

<span class="sd">    be forewarned- if mode is specified to a mode that blocks the euid</span>
<span class="sd">    from accessing the dir, this code *will* try to create the dir.</span>

<span class="sd">    :param path: directory to ensure exists on disk</span>
<span class="sd">    :param gid: a valid GID to set any created directories to</span>
<span class="sd">    :param uid: a valid UID to set any created directories to</span>
<span class="sd">    :param mode: permissions to set any created directories to</span>
<span class="sd">    :param minimal: boolean controlling whether or not the specified mode</span>
<span class="sd">        must be enforced, or is the minimal permissions necessary.  For example,</span>
<span class="sd">        if mode=0755, minimal=True, and a directory exists with mode 0707,</span>
<span class="sd">        this will restore the missing group perms resulting in 757.</span>
<span class="sd">    :return: True if the directory could be created/ensured to have those</span>
<span class="sd">        permissions, False if not.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">um</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="c"># if the dir perms would lack +wx, we have to force it</span>
            <span class="n">force_temp_perms</span> <span class="o">=</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mo">0300</span><span class="p">)</span> <span class="o">!=</span> <span class="mo">0300</span><span class="p">)</span>
            <span class="n">resets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">apath</span> <span class="o">=</span> <span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">sticky_parent</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">apath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                        <span class="k">return</span> <span class="bp">False</span>

                    <span class="c"># if it&#39;s a subdir, we need +wx at least</span>
                    <span class="k">if</span> <span class="n">apath</span> <span class="o">!=</span> <span class="n">base</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">0300</span><span class="p">)</span> <span class="o">!=</span> <span class="mo">0300</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="mo">0300</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                                <span class="k">return</span> <span class="bp">False</span>
                            <span class="n">resets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">))</span>
                        <span class="n">sticky_parent</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_gid</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISGID</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                    <span class="c"># nothing exists.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">force_temp_perms</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">_safe_mkdir</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mo">0700</span><span class="p">):</span>
                                <span class="k">return</span> <span class="bp">False</span>
                            <span class="n">resets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">_safe_mkdir</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
                                <span class="k">return</span> <span class="bp">False</span>
                            <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="n">apath</span> <span class="ow">and</span> <span class="n">sticky_parent</span><span class="p">:</span>
                                <span class="n">resets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">base</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">gid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">uid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">False</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">base</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">resets</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">gid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">um</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">gid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">gid</span> <span class="o">!=</span> <span class="n">st</span><span class="o">.</span><span class="n">st_gid</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">uid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">uid</span> <span class="o">!=</span> <span class="n">st</span><span class="o">.</span><span class="n">st_uid</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">minimal</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">mode</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">|</span> <span class="n">mode</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">!=</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">07777</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

</div>
<div class="viewcode-block" id="abssymlink"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.abssymlink">[docs]</a><span class="k">def</span> <span class="nf">abssymlink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the absolute path of a symlink</span>

<span class="sd">    :param path: filepath to resolve</span>
<span class="sd">    :return: resolved path</span>
<span class="sd">    :raise: EnvironmentError, errno=ENINVAL if the requested path isn&#39;t</span>
<span class="sd">        a symlink</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mylink</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mylink</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">mydir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">mylink</span> <span class="o">=</span> <span class="n">mydir</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">mylink</span>
    <span class="k">return</span> <span class="n">normpath</span><span class="p">(</span><span class="n">mylink</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="abspath"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.abspath">[docs]</a><span class="k">def</span> <span class="nf">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    resolve a path absolutely, including symlink resolving.</span>

<span class="sd">    Note that if it&#39;s a symlink and the target doesn&#39;t exist, it&#39;ll still</span>
<span class="sd">    return the target.</span>

<span class="sd">    :param path: filepath to resolve.</span>
<span class="sd">    :raise: EnvironmentError some errno other than an ENOENT or EINVAL</span>
<span class="sd">        is encountered</span>
<span class="sd">    :return: the absolute path calculated against the filesystem</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">abssymlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EINVAL</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">path</span>

</div>
<span class="k">def</span> <span class="nf">native_normpath</span><span class="p">(</span><span class="n">mypath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    normalize path- //usr/bin becomes /usr/bin, /usr/../bin becomes /bin</span>

<span class="sd">    see :py:func:`os.path.normpath` for details- this function differs from</span>
<span class="sd">    `os.path.normpath` only in that it&#39;ll convert leading &#39;//&#39; into &#39;/&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">mypath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newpath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">newpath</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">newpath</span>

<span class="n">native_join</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

<span class="k">def</span> <span class="nf">_internal_native_readfile</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">mypath</span><span class="p">,</span> <span class="n">none_on_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">strict</span><span class="o">=</span><span class="n">compatibility</span><span class="o">.</span><span class="n">is_py3k</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read a file, returning the contents</span>

<span class="sd">    :param mypath: fs path for the file to read</span>
<span class="sd">    :param none_on_missing: whether to return None if the file is missing,</span>
<span class="sd">        else through the exception</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">and</span> <span class="n">strict</span><span class="p">:</span>
            <span class="c"># we special case this- codecs.open is about 2x slower,</span>
            <span class="c"># thus if py3k, use the native one (which supports encoding directly)</span>
            <span class="k">if</span> <span class="n">compatibility</span><span class="o">.</span><span class="n">is_py3k</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">mypath</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mypath</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">mypath</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">oe</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">none_on_missing</span> <span class="ow">and</span> <span class="n">oe</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">_mk_pretty_derived_func</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">name_base</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">name</span>
    <span class="k">return</span> <span class="n">pretty_docs</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name_base</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

<span class="n">_mk_readfile</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_mk_pretty_derived_func</span><span class="p">,</span> <span class="n">_internal_native_readfile</span><span class="p">,</span>
    <span class="s">&#39;readfile&#39;</span><span class="p">)</span>

<span class="n">native_readfile_ascii</span> <span class="o">=</span> <span class="n">_mk_readfile</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="s">&#39;rt&#39;</span><span class="p">)</span>
<span class="n">native_readfile</span> <span class="o">=</span> <span class="n">native_readfile_ascii</span>
<span class="n">native_readfile_ascii_strict</span> <span class="o">=</span> <span class="n">_mk_readfile</span><span class="p">(</span><span class="s">&#39;ascii_strict&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">native_readfile_bytes</span> <span class="o">=</span> <span class="n">_mk_readfile</span><span class="p">(</span><span class="s">&#39;bytes&#39;</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">native_readfile_utf8</span> <span class="o">=</span> <span class="n">_mk_readfile</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">native_readfile_utf8_strict</span> <span class="o">=</span> <span class="n">_mk_readfile</span><span class="p">(</span><span class="s">&#39;utf8_strict&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">readlines_iter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;iterable&quot;</span><span class="p">,</span> <span class="s">&quot;mtime&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterable</span><span class="p">,</span> <span class="n">mtime</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterable</span> <span class="o">=</span> <span class="n">iterable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mtime</span> <span class="o">=</span> <span class="n">mtime</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterable</span>

<span class="k">def</span> <span class="nf">_py2k_ascii_strict_filter</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="nb">any</span> <span class="o">=</span> <span class="n">compatibility</span><span class="o">.</span><span class="n">any</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">((</span><span class="mh">0x80</span> <span class="o">&amp;</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">))</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;character ordinal over 127&quot;</span><span class="p">);</span>
        <span class="k">yield</span> <span class="n">line</span>


<span class="k">def</span> <span class="nf">_strip_whitespace_filter</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">native_readlines</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">mypath</span><span class="p">,</span> <span class="n">strip_whitespace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">swallow_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">none_on_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">compatibility</span><span class="o">.</span><span class="n">is_py3k</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    read a file, yielding each line</span>

<span class="sd">    :param mypath: fs path for the file to read</span>
<span class="sd">    :param strip_whitespace: strip any leading or trailing whitespace including newline?</span>
<span class="sd">    :param swallow_missing: throw an IOError if missing, or swallow it?</span>
<span class="sd">    :param none_on_missing: if the file is missing, return None, else</span>
<span class="sd">        if the file is missing return an empty iterable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">iterable</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">and</span> <span class="n">strict</span><span class="p">:</span>
            <span class="c"># we special case this- codecs.open is about 2x slower,</span>
            <span class="c"># thus if py3k, use the native one (which supports encoding directly)</span>
            <span class="k">if</span> <span class="n">compatibility</span><span class="o">.</span><span class="n">is_py3k</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">mypath</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mypath</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="s">&#39;ascii&#39;</span><span class="p">:</span>
                    <span class="n">iterable</span> <span class="o">=</span> <span class="n">_py2k_ascii_strict_filter</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">mypath</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">ie</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ie</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">swallow_missing</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="n">none_on_missing</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">readlines_iter</span><span class="p">(</span><span class="nb">iter</span><span class="p">([]),</span> <span class="bp">None</span><span class="p">)</span>

    <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fstat</span><span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span><span class="o">.</span><span class="n">st_mtime</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="n">iterable</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">strip_whitespace</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">readlines_iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">,</span> <span class="n">mtime</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">readlines_iter</span><span class="p">(</span><span class="n">_strip_whitespace_filter</span><span class="p">(</span><span class="n">iterable</span><span class="p">),</span> <span class="n">mtime</span><span class="p">)</span>


<span class="n">_mk_readlines</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">_mk_pretty_derived_func</span><span class="p">,</span> <span class="n">native_readlines</span><span class="p">,</span>
    <span class="s">&#39;readlines&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">snakeoil.osutils._posix</span> <span class="kn">import</span> <span class="n">normpath</span><span class="p">,</span> <span class="n">join</span><span class="p">,</span> <span class="n">readfile</span><span class="p">,</span> <span class="n">readlines</span>
    <span class="n">readfile_ascii</span> <span class="o">=</span> <span class="n">readfile</span>
    <span class="n">readlines_ascii</span> <span class="o">=</span> <span class="n">readlines</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">normpath</span> <span class="o">=</span> <span class="n">native_normpath</span>
    <span class="n">join</span> <span class="o">=</span> <span class="n">native_join</span>
    <span class="n">readfile_ascii</span> <span class="o">=</span> <span class="n">native_readfile_ascii</span>
    <span class="n">readfile</span> <span class="o">=</span> <span class="n">native_readfile</span>
    <span class="n">readlines_ascii</span> <span class="o">=</span> <span class="n">_mk_readlines</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span>
        <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="n">readlines</span> <span class="o">=</span> <span class="n">readlines_ascii</span>

<span class="n">readlines_bytes</span> <span class="o">=</span> <span class="n">_mk_readlines</span><span class="p">(</span><span class="s">&#39;bytes&#39;</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">readlines_ascii_strict</span> <span class="o">=</span> <span class="n">_mk_readlines</span><span class="p">(</span><span class="s">&#39;ascii_strict&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">readlines_utf8</span> <span class="o">=</span> <span class="n">_mk_readlines</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">)</span>
<span class="n">readlines_utf8_strict</span> <span class="o">=</span> <span class="n">_mk_readlines</span><span class="p">(</span><span class="s">&#39;utf8_strict&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="n">readfile_ascii_strict</span> <span class="o">=</span> <span class="n">native_readfile_ascii_strict</span>
<span class="n">readfile_bytes</span> <span class="o">=</span> <span class="n">native_readfile_bytes</span>
<span class="n">readfile_utf8</span> <span class="o">=</span> <span class="n">native_readfile_utf8</span>
<span class="n">readfile_utf8_strict</span> <span class="o">=</span> <span class="n">native_readfile_utf8_strict</span>

<span class="c"># convenience.  importing join into a namespace is ugly, pjoin less so</span>
<span class="n">pjoin</span> <span class="o">=</span> <span class="n">join</span>

<div class="viewcode-block" id="LockException"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.LockException">[docs]</a><span class="k">class</span> <span class="nc">LockException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base lock exception class&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">path</span><span class="p">,</span> <span class="n">reason</span>
</div>
<div class="viewcode-block" id="NonExistant"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.NonExistant">[docs]</a><span class="k">class</span> <span class="nc">NonExistant</span><span class="p">(</span><span class="n">LockException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Missing file/dir exception&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">LockException</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s">&quot;Lock action for &#39;</span><span class="si">%s</span><span class="s">&#39; failed due to not being a valid dir/file </span><span class="si">%s</span><span class="s">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="GenericFailed"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.GenericFailed">[docs]</a><span class="k">class</span> <span class="nc">GenericFailed</span><span class="p">(</span><span class="n">LockException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The fallback lock exception class.</span>

<span class="sd">    Covers perms, IOError&#39;s, and general whackyness.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Lock action for &#39;</span><span class="si">%s</span><span class="s">&#39; failed due to &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>


<span class="c"># should the fd be left open indefinitely?</span>
<span class="c"># IMO, it shouldn&#39;t, but opening/closing everytime around is expensive</span>

</div>
<div class="viewcode-block" id="FsLock"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.FsLock">[docs]</a><span class="k">class</span> <span class="nc">FsLock</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fnctl based filesystem lock</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">WeakRefFinalizer</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">,</span> <span class="s">&quot;fd&quot;</span><span class="p">,</span> <span class="s">&quot;create&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param path: fs path for the lock</span>
<span class="sd">        :param create: controls whether the file will be created</span>
<span class="sd">            if the file doesn&#39;t exist.</span>
<span class="sd">            If true, the base dir must exist, and it will create a file.</span>
<span class="sd">            If you want to lock via a dir, you have to ensure it exists</span>
<span class="sd">            (create doesn&#39;t suffice).</span>
<span class="sd">        :raise NonExistant: if no file/dir exists for that path,</span>
<span class="sd">            and cannot be created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">create</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">create</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">NonExistant</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_acquire_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">oe</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GenericFailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">oe</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">oe</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NonExistant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">oe</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_enact_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">blocking</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acquire_fd</span><span class="p">()</span>
        <span class="c"># we do it this way, due to the fact try/except is a bit of a hit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">blocking</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">flags</span><span class="o">|</span><span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">ie</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ie</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">raise</span> <span class="n">GenericFailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">ie</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="FsLock.acquire_write_lock"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.FsLock.acquire_write_lock">[docs]</a>    <span class="k">def</span> <span class="nf">acquire_write_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Acquire an exclusive lock</span>

<span class="sd">        Note if you have a read lock, it implicitly upgrades atomically</span>

<span class="sd">        :param blocking: if enabled, don&#39;t return until we have the lock</span>
<span class="sd">        :return: True if lock is acquired, False if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enact_change</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span><span class="p">,</span> <span class="n">blocking</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FsLock.acquire_read_lock"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.FsLock.acquire_read_lock">[docs]</a>    <span class="k">def</span> <span class="nf">acquire_read_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Acquire a shared lock</span>

<span class="sd">        Note if you have a write lock, it implicitly downgrades atomically</span>

<span class="sd">        :param blocking: if enabled, don&#39;t return until we have the lock</span>
<span class="sd">        :return: True if lock is acquired, False if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enact_change</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_SH</span><span class="p">,</span> <span class="n">blocking</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FsLock.release_write_lock"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.FsLock.release_write_lock">[docs]</a>    <span class="k">def</span> <span class="nf">release_write_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Release an write/exclusive lock if held&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enact_change</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FsLock.release_read_lock"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.FsLock.release_read_lock">[docs]</a>    <span class="k">def</span> <span class="nf">release_read_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Release an shared/read lock if held&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_enact_change</span><span class="p">(</span><span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># alright, it&#39;s 5:45am, yes this is weird code.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">release_read_lock</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">fallback_access</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c"># rules roughly are as follows; if process uid == file uid, those perms</span>
    <span class="c"># apply.</span>
    <span class="c"># if groups match... that perm group is the fallback (authorative)</span>
    <span class="c"># if neither, then other</span>
    <span class="c"># if root, w/r is guranteed, x is actually checked</span>
    <span class="c"># note posix says X_OK can be True, which is a worthless result, hence this</span>
    <span class="c"># fallback for systems that take advantage of that posix misfeature.</span>

    <span class="n">myuid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span>

    <span class="c"># if we&#39;re root... pull out X_OK and check that alone.  the rules of</span>
    <span class="c"># X_OK under linux (which this function emulates) are that any +x is a True</span>
    <span class="c"># as for WR, that&#39;s always allowed (well not always- selinux may change that)</span>

    <span class="k">if</span> <span class="n">myuid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">&amp;=</span> <span class="n">os</span><span class="o">.</span><span class="n">X_OK</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span><span class="p">:</span>
            <span class="c"># w/r are always True for root, so return up front</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="c"># py3k doesn&#39;t like octal syntax; this is 0111</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mi">73</span><span class="p">)</span>

    <span class="n">mygroups</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getgroups</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">myuid</span> <span class="o">==</span> <span class="n">st</span><span class="o">.</span><span class="n">st_uid</span><span class="p">:</span>
        <span class="c"># shift to the user octet, filter to 3 bits, verify intersect.</span>
        <span class="k">return</span> <span class="n">mode</span> <span class="o">==</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">st_gid</span> <span class="ow">in</span> <span class="n">mygroups</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mode</span> <span class="o">==</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">mode</span> <span class="o">==</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span>

<span class="n">fallback_access</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">,</span> <span class="s">&#39;__doc__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="k">if</span> <span class="s">&#39;sunos&#39;</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
    <span class="c"># XXX snakeoil needs to grow a &quot;steal the docs from another function&quot;</span>
    <span class="n">access</span> <span class="o">=</span> <span class="n">fallback_access</span>
    <span class="n">access</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="s">&#39;access&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">access</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span>

<div class="viewcode-block" id="unlink_if_exists"><a class="viewcode-back" href="../../api/snakeoil.osutils.html#snakeoil.osutils.unlink_if_exists">[docs]</a><span class="k">def</span> <span class="nf">unlink_if_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    wrap os.unlink, ignoring if the file doesn&#39;t exist</span>

<span class="sd">    :param path: a non directory target to ensure doesn&#39;t exist</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
            <span class="k">raise</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">snakeoil v-trunk documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, Brian Harring.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>