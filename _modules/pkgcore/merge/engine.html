

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pkgcore.merge.engine &mdash; pkgcore vtrunk documentation</title>
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     'trunk',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="pkgcore vtrunk documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pkgcore vtrunk documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pkgcore.merge.engine</h1><div class="highlight"><pre>
<span class="c"># Copyright: 2005-2011 Brian Harring &lt;ferringb@gmail.com&gt;</span>
<span class="c"># License: GPL2/BSD</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">core engine for livefs modifications</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;alias_cset&quot;</span><span class="p">,</span> <span class="s">&quot;map_new_cset_livefs&quot;</span><span class="p">,</span> <span class="s">&quot;MergeEngine&quot;</span><span class="p">)</span>

<span class="c"># need better documentation...</span>

<span class="c"># pre merge triggers</span>
<span class="c"># post merge triggers</span>
<span class="c"># ordering?</span>

<span class="kn">import</span> <span class="nn">operator</span>

<span class="kn">from</span> <span class="nn">pkgcore.fs</span> <span class="kn">import</span> <span class="n">contents</span><span class="p">,</span> <span class="n">livefs</span>
<span class="kn">from</span> <span class="nn">pkgcore.plugin</span> <span class="kn">import</span> <span class="n">get_plugins</span>
<span class="kn">from</span> <span class="nn">pkgcore.merge</span> <span class="kn">import</span> <span class="n">errors</span>
<span class="kn">from</span> <span class="nn">pkgcore.operations</span> <span class="kn">import</span> <span class="n">observer</span> <span class="k">as</span> <span class="n">observer_mod</span>
<span class="kn">from</span> <span class="nn">pkgcore.merge.const</span> <span class="kn">import</span> <span class="n">REPLACE_MODE</span><span class="p">,</span> <span class="n">INSTALL_MODE</span><span class="p">,</span> <span class="n">UNINSTALL_MODE</span>

<span class="kn">from</span> <span class="nn">snakeoil.mappings</span> <span class="kn">import</span> <span class="n">LazyValDict</span><span class="p">,</span> <span class="n">ImmutableDict</span><span class="p">,</span> <span class="n">StackedDict</span>
<span class="kn">from</span> <span class="nn">snakeoil</span> <span class="kn">import</span> <span class="n">currying</span><span class="p">,</span> <span class="n">data_source</span>
<span class="kn">from</span> <span class="nn">snakeoil.osutils</span> <span class="kn">import</span> <span class="n">normpath</span><span class="p">,</span> <span class="n">pjoin</span>

<span class="kn">from</span> <span class="nn">snakeoil.demandload</span> <span class="kn">import</span> <span class="n">demandload</span>
<span class="n">demandload</span><span class="p">(</span><span class="nb">globals</span><span class="p">(),</span>
    <span class="s">&quot;tempfile&quot;</span><span class="p">,</span>
    <span class="s">&quot;traceback&quot;</span><span class="p">,</span>
    <span class="s">&quot;snakeoil:stringio&quot;</span><span class="p">,</span>
<span class="p">)</span>

<div class="viewcode-block" id="alias_cset"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.alias_cset">[docs]</a><span class="k">def</span> <span class="nf">alias_cset</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;alias a cset to another&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">csets</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="map_new_cset_livefs"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.map_new_cset_livefs">[docs]</a><span class="k">def</span> <span class="nf">map_new_cset_livefs</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="n">cset_name</span><span class="o">=</span><span class="s">&#39;new_cset&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;find the syms on disk that redirect new_cset, and return a cset</span>
<span class="sd">    localized to the livefs&quot;&quot;&quot;</span>
    <span class="n">initial</span> <span class="o">=</span> <span class="n">csets</span><span class="p">[</span><span class="n">cset_name</span><span class="p">]</span>
    <span class="n">ondisk</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">contentsSet</span><span class="p">(</span><span class="n">livefs</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">iterdirs</span><span class="p">(),</span>
        <span class="n">realpath</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="n">livefs</span><span class="o">.</span><span class="n">recursively_fill_syms</span><span class="p">(</span><span class="n">ondisk</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">map_directory_structure</span><span class="p">(</span><span class="n">ondisk</span><span class="p">,</span> <span class="n">add_conflicting_sym</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span>

</div>
<div class="viewcode-block" id="MergeEngine"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine">[docs]</a><span class="k">class</span> <span class="nc">MergeEngine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">install_hooks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s">&quot;sanity_check&quot;</span><span class="p">,</span> <span class="s">&quot;pre_merge&quot;</span><span class="p">,</span> <span class="s">&quot;merge&quot;</span><span class="p">,</span> <span class="s">&quot;post_merge&quot;</span><span class="p">,</span> <span class="s">&quot;final&quot;</span><span class="p">])</span>
    <span class="n">uninstall_hooks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s">&quot;sanity_check&quot;</span><span class="p">,</span> <span class="s">&quot;pre_unmerge&quot;</span><span class="p">,</span> <span class="s">&quot;unmerge&quot;</span><span class="p">,</span> <span class="s">&quot;post_unmerge&quot;</span><span class="p">,</span> <span class="s">&quot;final&quot;</span><span class="p">])</span>
    <span class="n">replace_hooks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">install_hooks</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">+</span> <span class="n">uninstall_hooks</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="n">install_csets</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;install_existing&quot;</span><span class="p">:</span><span class="s">&quot;get_install_livefs_intersect&quot;</span><span class="p">,</span>
        <span class="s">&quot;resolved_install&quot;</span><span class="p">:</span> <span class="n">map_new_cset_livefs</span><span class="p">,</span>
        <span class="s">&#39;new_cset&#39;</span><span class="p">:</span><span class="n">currying</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">alias_cset</span><span class="p">,</span> <span class="s">&#39;raw_new_cset&#39;</span><span class="p">),</span>
        <span class="s">&quot;install&quot;</span><span class="p">:</span><span class="n">currying</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">alias_cset</span><span class="p">,</span> <span class="s">&#39;new_cset&#39;</span><span class="p">),</span>
        <span class="s">&quot;replace&quot;</span><span class="p">:</span><span class="n">currying</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">alias_cset</span><span class="p">,</span> <span class="s">&#39;new_cset&#39;</span><span class="p">)}</span>
    <span class="n">uninstall_csets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;uninstall_existing&quot;</span><span class="p">:</span><span class="n">currying</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">alias_cset</span><span class="p">,</span> <span class="s">&quot;uninstall&quot;</span><span class="p">),</span>
        <span class="s">&quot;uninstall&quot;</span><span class="p">:</span><span class="n">currying</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">alias_cset</span><span class="p">,</span> <span class="s">&quot;old_cset&quot;</span><span class="p">),</span>
        <span class="s">&quot;old_cset&quot;</span><span class="p">:</span><span class="s">&quot;get_uninstall_livefs_intersect&quot;</span><span class="p">}</span>
    <span class="n">replace_csets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">install_csets</span><span class="p">)</span>
    <span class="n">replace_csets</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">uninstall_csets</span><span class="p">)</span>
    <span class="n">replace_csets</span><span class="p">[</span><span class="s">&quot;modifying&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="k">lambda</span> <span class="n">e</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s">&quot;resolved_install&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s">&quot;uninstall&quot;</span><span class="p">]))</span>
    <span class="n">replace_csets</span><span class="p">[</span><span class="s">&quot;uninstall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;get_remove_cset&quot;</span>
    <span class="n">replace_csets</span><span class="p">[</span><span class="s">&quot;replace&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;get_replace_cset&quot;</span>
    <span class="n">replace_csets</span><span class="p">[</span><span class="s">&quot;install_existing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;get_install_livefs_intersect&quot;</span>

    <span class="n">install_csets_preserve</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;new_cset&quot;</span><span class="p">]</span>
    <span class="n">uninstall_csets_preserve</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;old_cset&quot;</span><span class="p">]</span>
    <span class="n">replace_csets_preserve</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;new_cset&quot;</span><span class="p">,</span> <span class="s">&quot;old_cset&quot;</span><span class="p">]</span>

    <span class="n">allow_reuse</span> <span class="o">=</span> <span class="bp">True</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">hooks</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="n">preserves</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span>
        <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">disable_plugins</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">observer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">observer</span> <span class="o">=</span> <span class="n">observer_mod</span><span class="o">.</span><span class="n">repo_observer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="n">observer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="n">tempdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tempdir</span> <span class="o">=</span> <span class="n">normpath</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempdir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span> <span class="o">=</span> <span class="n">ImmutableDict</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preserve_csets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cset_sources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># instantiate these seperately so their values are preserved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preserved_csets</span> <span class="o">=</span> <span class="n">LazyValDict</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preserve_csets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cset_source</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">csets</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s">&quot;cset values must be either the string name of &quot;</span>
                    <span class="s">&quot;existing methods, or callables (got </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">preserves</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_preserved_cset</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_cset</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">disable_plugins</span><span class="p">:</span>
            <span class="c"># merge in default triggers first.</span>
            <span class="k">for</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="n">get_plugins</span><span class="p">(</span><span class="s">&#39;triggers&#39;</span><span class="p">):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">trigger</span><span class="p">()</span>
                <span class="n">t</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># merge in overrides</span>
        <span class="k">for</span> <span class="n">hook</span><span class="p">,</span> <span class="n">triggers</span> <span class="ow">in</span> <span class="n">hooks</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="n">triggers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_trigger</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">regenerate_csets</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">currying</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute_hook</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MergeEngine.install"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.install">[docs]</a>    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">disable_plugins</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generate a MergeEngine instance configured for uninstalling a pkg</span>

<span class="sd">        :param tempdir: tempspace for the merger to use; this space it must</span>
<span class="sd">            control alone, no sharing.</span>
<span class="sd">        :param pkg: L{pkgcore.package.metadata.package} instance to install</span>
<span class="sd">        :param offset: any livefs offset to force for modifications</span>
<span class="sd">        :param disable_plugins: if enabled, run just the triggers passed in</span>
<span class="sd">        :return: L{MergeEngine}</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hooks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">install_hooks</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>

        <span class="n">csets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">install_csets</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;raw_new_cset&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">csets</span><span class="p">:</span>
            <span class="n">csets</span><span class="p">[</span><span class="s">&quot;raw_new_cset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currying</span><span class="o">.</span><span class="n">post_curry</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">get_pkg_contents</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">INSTALL_MODE</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">hooks</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">install_csets_preserve</span><span class="p">,</span>
            <span class="n">observer</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">disable_plugins</span><span class="o">=</span><span class="n">disable_plugins</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="c"># wrap the results of new_cset to pass through an offset generator</span>
            <span class="n">o</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">[</span><span class="s">&quot;raw_new_cset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currying</span><span class="o">.</span><span class="n">post_curry</span><span class="p">(</span>
                <span class="n">o</span><span class="o">.</span><span class="n">generate_offset_cset</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">[</span><span class="s">&quot;raw_new_cset&quot;</span><span class="p">])</span>

        <span class="n">o</span><span class="o">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">pkg</span>
        <span class="k">return</span> <span class="n">o</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MergeEngine.uninstall"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.uninstall">[docs]</a>    <span class="k">def</span> <span class="nf">uninstall</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">pkg</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">disable_plugins</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generate a MergeEngine instance configured for uninstalling a pkg</span>

<span class="sd">        :param tempdir: tempspace for the merger to use; this space it must</span>
<span class="sd">            control alone, no sharing.</span>
<span class="sd">        :param pkg: L{pkgcore.package.metadata.package} instance to uninstall,</span>
<span class="sd">            must be from a livefs vdb</span>
<span class="sd">        :param offset: any livefs offset to force for modifications</span>
<span class="sd">        :param disable_plugins: if enabled, run just the triggers passed in</span>
<span class="sd">        :return: L{MergeEngine}</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hooks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">uninstall_hooks</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>
        <span class="n">csets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">uninstall_csets</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&quot;raw_old_cset&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">csets</span><span class="p">:</span>
            <span class="n">csets</span><span class="p">[</span><span class="s">&quot;raw_old_cset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currying</span><span class="o">.</span><span class="n">post_curry</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">get_pkg_contents</span><span class="p">,</span>
                <span class="n">pkg</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">UNINSTALL_MODE</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">hooks</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">uninstall_csets_preserve</span><span class="p">,</span>
            <span class="n">observer</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">disable_plugins</span><span class="o">=</span><span class="n">disable_plugins</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="c"># wrap the results of new_cset to pass through an offset generator</span>
            <span class="n">o</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">[</span><span class="s">&quot;old_cset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currying</span><span class="o">.</span><span class="n">post_curry</span><span class="p">(</span>
                <span class="n">o</span><span class="o">.</span><span class="n">generate_offset_cset</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">[</span><span class="s">&quot;old_cset&quot;</span><span class="p">])</span>

        <span class="n">o</span><span class="o">.</span><span class="n">old</span> <span class="o">=</span> <span class="n">pkg</span>
        <span class="k">return</span> <span class="n">o</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="MergeEngine.replace"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">disable_plugins</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        generate a MergeEngine instance configured for replacing a pkg.</span>

<span class="sd">        :param tempdir: tempspace for the merger to use; this space it must</span>
<span class="sd">            control alone, no sharing.</span>
<span class="sd">        :param old: L{pkgcore.package.metadata.package} instance to replace,</span>
<span class="sd">            must be from a livefs vdb</span>
<span class="sd">        :param new: L{pkgcore.package.metadata.package} instance</span>
<span class="sd">        :param offset: any livefs offset to force for modifications</span>
<span class="sd">        :param disable_plugins: if enabled, run just the triggers passed in</span>
<span class="sd">        :return: L{MergeEngine}</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hooks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">replace_hooks</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>

        <span class="n">csets</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">replace_csets</span><span class="p">)</span>

        <span class="n">csets</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;raw_old_cset&#39;</span><span class="p">,</span> <span class="n">currying</span><span class="o">.</span><span class="n">post_curry</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">get_pkg_contents</span><span class="p">,</span> <span class="n">old</span><span class="p">))</span>
        <span class="n">csets</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;raw_new_cset&#39;</span><span class="p">,</span> <span class="n">currying</span><span class="o">.</span><span class="n">post_curry</span><span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">get_pkg_contents</span><span class="p">,</span> <span class="n">new</span><span class="p">))</span>

        <span class="n">o</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span>
            <span class="n">REPLACE_MODE</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">,</span> <span class="n">hooks</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">replace_csets_preserve</span><span class="p">,</span>
            <span class="n">observer</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">disable_plugins</span><span class="o">=</span><span class="n">disable_plugins</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">offset</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;raw_old_cset&quot;</span><span class="p">,</span> <span class="s">&quot;raw_new_cset&quot;</span><span class="p">):</span>
                <span class="c"># wrap the results of new_cset to pass through an</span>
                <span class="c"># offset generator</span>
                <span class="n">o</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">currying</span><span class="o">.</span><span class="n">post_curry</span><span class="p">(</span>
                    <span class="n">o</span><span class="o">.</span><span class="n">generate_offset_cset</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">o</span><span class="o">.</span><span class="n">old</span> <span class="o">=</span> <span class="n">old</span>
        <span class="n">o</span><span class="o">.</span><span class="n">new</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">return</span> <span class="n">o</span>
</div>
<div class="viewcode-block" id="MergeEngine.replace_cset"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.replace_cset">[docs]</a>    <span class="k">def</span> <span class="nf">replace_cset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">new_cset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        replace the cset referenced by this engine; use only if you know what you&#39;re doing</span>

<span class="sd">        :param name: name of the cset</span>
<span class="sd">        :new_cset: a contentsSet instance to use</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preserved_csets</span><span class="p">:</span>
            <span class="c"># yes this is evil awareness of LazyValDict internals...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preserved_csets</span><span class="o">.</span><span class="n">_vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_cset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;attempted to replace a non preserved cset: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>
</div>
<div class="viewcode-block" id="MergeEngine.regenerate_csets"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.regenerate_csets">[docs]</a>    <span class="k">def</span> <span class="nf">regenerate_csets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        internal function, reset non preserverd csets.</span>

<span class="sd">        Used in transitioning between hook points</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csets</span> <span class="o">=</span> <span class="n">StackedDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preserved_csets</span><span class="p">,</span>
            <span class="n">LazyValDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cset_source</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_get_cset_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">csets</span><span class="p">)</span>

<div class="viewcode-block" id="MergeEngine.add_preserved_cset"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.add_preserved_cset">[docs]</a>    <span class="k">def</span> <span class="nf">add_preserved_cset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cset_name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        register a cset generator for use.</span>

<span class="sd">        The cset will stay in memory until the engine finishes all steps.</span>

<span class="sd">        :param cset_name: what to call the generated cset</span>
<span class="sd">        :param func: callable to get the cset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_cset</span><span class="p">(</span><span class="n">cset_name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preserve_csets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cset_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MergeEngine.add_cset"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.add_cset">[docs]</a>    <span class="k">def</span> <span class="nf">add_cset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cset_name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        regiser a cset generator for use.</span>

<span class="sd">        The cset will be released from memory when it&#39;s no longer used.</span>

<span class="sd">        :param cset_name: what to call the generated cset</span>
<span class="sd">        :param func: callable to get the cset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;func must be a callable&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cset_name</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;cset_name must be a string&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">[</span><span class="n">cset_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
</div>
<div class="viewcode-block" id="MergeEngine.add_trigger"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.add_trigger">[docs]</a>    <span class="k">def</span> <span class="nf">add_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook_name</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="n">required_csets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        register a L{pkgcore.merge.triggers.base} instance to be executed</span>

<span class="sd">        :param hook_name: engine step to hook the trigger into</span>
<span class="sd">        :param trigger: L{triggers&lt;pkgcore.merge.triggers.base&gt;} to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">hook_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&quot;trigger </span><span class="si">%r</span><span class="s">&#39;s hook </span><span class="si">%s</span><span class="s"> isn&#39;t a known hook&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="n">hook_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">required_csets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rcs</span> <span class="ow">in</span> <span class="n">required_csets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rcs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cset_sources</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rcs</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">TriggerUnknownCset</span><span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="n">rcs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">hook_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trigger</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="MergeEngine.execute_hook"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.execute_hook">[docs]</a>    <span class="k">def</span> <span class="nf">execute_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        execute any triggers bound to a hook point</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">hook</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regenerate_csets</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">trigger</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hooks</span><span class="p">[</span><span class="n">hook</span><span class="p">],</span>
                <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s">&quot;priority&quot;</span><span class="p">)):</span>
                <span class="c"># error checking needed here.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">trigger_start</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">csets</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">BlockModification</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;modification was blocked by &quot;</span>
                            <span class="s">&quot;trigger </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trigger</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="n">errors</span><span class="o">.</span><span class="n">ModificationError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;modification error occured &quot;</span>
                            <span class="s">&quot;during trigger </span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trigger</span><span class="p">,</span><span class="n">e</span><span class="p">))</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">trigger</span><span class="o">.</span><span class="n">suppress_exception</span><span class="p">:</span>
                            <span class="k">raise</span>

                        <span class="n">handle</span> <span class="o">=</span> <span class="n">stringio</span><span class="o">.</span><span class="n">text_writable</span><span class="p">()</span>
                        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">handle</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;unhandled exception caught and &quot;</span>
                            <span class="s">&quot;suppressed:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">handle</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),))</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="o">.</span><span class="n">trigger_end</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="n">trigger</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="bp">None</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MergeEngine.generate_offset_cset"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.generate_offset_cset">[docs]</a>    <span class="k">def</span> <span class="nf">generate_offset_cset</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="n">cset_generator</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;generate a cset with offset applied&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">cset_generator</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">)</span><span class="o">.</span><span class="n">insert_offset</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MergeEngine.get_pkg_contents"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.get_pkg_contents">[docs]</a>    <span class="k">def</span> <span class="nf">get_pkg_contents</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="n">pkg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;generate the cset of what files shall be merged to the livefs&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pkg</span><span class="o">.</span><span class="n">contents</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MergeEngine.get_remove_cset"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.get_remove_cset">[docs]</a>    <span class="k">def</span> <span class="nf">get_remove_cset</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;generate the cset of what files shall be removed from the livefs&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">csets</span><span class="p">[</span><span class="s">&quot;old_cset&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">csets</span><span class="p">[</span><span class="s">&quot;resolved_install&quot;</span><span class="p">])</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MergeEngine.get_replace_cset"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.get_replace_cset">[docs]</a>    <span class="k">def</span> <span class="nf">get_replace_cset</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the cset of what will be replaced going from old-&gt;new pkg.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">csets</span><span class="p">[</span><span class="s">&quot;resolved_install&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">csets</span><span class="p">[</span><span class="s">&quot;old_cset&quot;</span><span class="p">])</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_livefs_intersect_cset</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="n">cset_name</span><span class="p">,</span> <span class="n">realpath</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;generates the livefs intersection against a cset&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">contents</span><span class="o">.</span><span class="n">contentsSet</span><span class="p">(</span><span class="n">livefs</span><span class="o">.</span><span class="n">intersect</span><span class="p">(</span><span class="n">csets</span><span class="p">[</span><span class="n">cset_name</span><span class="p">],</span>
            <span class="n">realpath</span><span class="o">=</span><span class="n">realpath</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MergeEngine.get_install_livefs_intersect"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.get_install_livefs_intersect">[docs]</a>    <span class="k">def</span> <span class="nf">get_install_livefs_intersect</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">engine</span><span class="o">.</span><span class="n">_get_livefs_intersect_cset</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="s">&quot;install&quot;</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="MergeEngine.get_uninstall_livefs_intersect"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.get_uninstall_livefs_intersect">[docs]</a>    <span class="k">def</span> <span class="nf">get_uninstall_livefs_intersect</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">engine</span><span class="o">.</span><span class="n">_get_livefs_intersect_cset</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">csets</span><span class="p">,</span> <span class="s">&quot;raw_old_cset&quot;</span><span class="p">)</span>
</div>
    <span class="n">alias_cset</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">alias_cset</span><span class="p">)</span>

<div class="viewcode-block" id="MergeEngine.get_merged_cset"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.get_merged_cset">[docs]</a>    <span class="k">def</span> <span class="nf">get_merged_cset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strip_offset</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">cset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csets</span><span class="p">[</span><span class="s">&quot;install&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">strip_offset</span><span class="p">:</span>
            <span class="n">rewrite</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">change_offset_rewriter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">,</span>
                <span class="n">cset</span><span class="p">)</span>
            <span class="n">cset</span> <span class="o">=</span> <span class="n">contents</span><span class="o">.</span><span class="n">contentsSet</span><span class="p">(</span><span class="n">cset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cset</span>
</div>
<div class="viewcode-block" id="MergeEngine.get_writable_fsobj"><a class="viewcode-back" href="../../../api/pkgcore.merge.engine.html#pkgcore.merge.engine.MergeEngine.get_writable_fsobj">[docs]</a>    <span class="k">def</span> <span class="nf">get_writable_fsobj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsobj</span><span class="p">,</span> <span class="n">prefer_reuse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">empty</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">source</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">fsobj</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">fsobj</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">mutable</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fsobj</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_reuse</span> <span class="ow">and</span> <span class="n">prefer_reuse</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">path</span>

                <span class="c"># XXX: this should be doing abspath fs intersection probably,</span>
                <span class="c"># although the paths generated are from triggers/engine- still.</span>

                <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">):</span>
                    <span class="c"># the fsobj pathway isn&#39;t in temp space; force a transfer.</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="c"># ok, it&#39;s tempspace, and reusable.</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">data_source</span><span class="o">.</span><span class="n">local_source</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="n">encoding</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">empty</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">bytes_fileobj</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">obj</span>

        <span class="c"># clone it into tempspace; it&#39;s required we control the tempspace,</span>
        <span class="c"># so this function is safe in our usage.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;merge-engine-&#39;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="p">)</span>

        <span class="c"># XXX: annoying quirk of python, we don&#39;t want append mode, so &#39;a+&#39;</span>
        <span class="c"># isn&#39;t viable; wr will truncate the file, so data_source uses r+.</span>
        <span class="c"># this however doesn&#39;t allow us to state &quot;create if missing&quot;</span>
        <span class="c"># so we create it ourselves.  Annoying, but so it goes.</span>
        <span class="c"># just touch the filepath.</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">new_source</span> <span class="o">=</span> <span class="n">data_source</span><span class="o">.</span><span class="n">local_source</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">fsobj</span><span class="p">,</span> <span class="s">&#39;encoding&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">empty</span><span class="p">:</span>
            <span class="n">data_source</span><span class="o">.</span><span class="n">transfer</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">bytes_fsobj</span><span class="p">(),</span> <span class="n">new_source</span><span class="o">.</span><span class="n">bytes_fsobj</span><span class="p">(</span><span class="bp">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_source</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">pkgcore vtrunk documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2010, Brian Harring, Marien Zwart.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.1.
    </div>
  </body>
</html>